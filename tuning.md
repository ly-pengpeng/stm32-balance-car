# STM32平衡小车PID参数调试指南

## PID参数调试原则

### 基本调试步骤
1. **先调P（比例）**: 让小车有反应但不振荡
2. **再调D（微分）**: 抑制振荡，提高稳定性
3. **最后调I（积分）**: 消除静态误差
4. **微调优化**: 根据实际效果精细调整

## 初始参数建议

### 基础参数（参考值）
```c
// 在 parameters.h 中设置
#define PID_KP 15.0f      // 比例系数
#define PID_KI 0.05f      // 积分系数  
#define PID_KD 0.1f       // 微分系数
#define MAX_OUTPUT 255    // 最大输出限制
#define DEAD_ZONE 2.0f    // 死区范围（度）
```

## 调试方法

### 1. 比例系数（KP）调试
- **现象**: 小车反应迟钝，无法保持平衡
- **调整**: 逐步增加KP值
- **目标**: 小车能够快速响应倾斜，但不要过度振荡

### 2. 微分系数（KD）调试  
- **现象**: 小车振荡明显，稳定性差
- **调整**: 增加KD值抑制振荡
- **目标**: 小车稳定平衡，无明显振荡

### 3. 积分系数（KI）调试
- **现象**: 小车有静态误差，无法完全垂直
- **调整**: 适当增加KI值
- **注意**: KI值不宜过大，否则会引起积分饱和

## 串口调试命令

通过串口可以实时调整参数（波特率115200）：

```
set kp 15.0    # 设置比例系数
set ki 0.05    # 设置积分系数
set kd 0.1     # 设置微分系数
set angle 0.0  # 设置目标角度
get status     # 获取当前状态
reset          # 重置PID控制器
```

## 常见问题及解决方案

### 问题1: 小车剧烈振荡
**原因**: KP值过大或KD值过小
**解决**: 
- 减小KP值
- 增加KD值
- 检查传感器数据是否稳定

### 问题2: 小车反应迟钝
**原因**: KP值过小
**解决**: 
- 逐步增加KP值
- 检查电机响应速度

### 问题3: 小车偏向一侧
**原因**: 机械不平衡或KI值不当
**解决**:
- 调整机械结构
- 微调KI值
- 检查电机一致性

### 问题4: 电机发热严重
**原因**: 输出饱和或频繁正反转
**解决**:
- 降低MAX_OUTPUT值
- 增加死区范围
- 优化PID参数

## 高级调试技巧

### 1. 数据记录分析
使用串口输出角度和输出值，绘制曲线分析：
```
Angle:2.35, Output:45.2
Angle:1.87, Output:38.1
...
```

### 2. 分段调试
- 先让小车在支架上调试
- 再在地面低速测试
- 最后进行完整平衡测试

### 3. 安全保护
- 设置角度保护（MAX_ANGLE）
- 加入急停功能
- 监控电池电压

## 参数优化建议

### 不同场景下的参数范围
- **室内平滑地面**: KP=10-20, KI=0.02-0.1, KD=0.05-0.3
- **室外粗糙地面**: KP=15-25, KI=0.05-0.15, KD=0.1-0.5
- **重载情况**: KP=20-30, KI=0.1-0.2, KD=0.3-0.8

### 自适应调整
可以考虑实现参数的自适应调整：
- 根据倾斜速度动态调整KD
- 根据误差大小调整KP
- 根据运行时间调整KI

记住：调试需要耐心，每次只调整一个参数，观察效果后再继续。